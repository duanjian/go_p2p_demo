由于在两个局域网内部，两台设备并没有公网IP，彼此要通信需要借助路由器，但是路由器又会对不识别的ip进行过滤，也就是路由器有个陌生人排除机制！怎么办呢？类似于我们去一个安保较为严格的场所时，需要内部的工作人员接引才可入内，在网络编程中也是这样的原理！但和现实中不同的是，假设设备A想和另一个局域网的设备B通信，设备B是并不认识设备A的，设备A通过路由器NAT（Network Address Translation，网络地址转换）技术获得了一个公网映射IP，但是设备B并不认识，那么怎么样能让两者通信呢？所以这个时候需要一个介绍人，此时需要有一个公网的服务器作为媒介，介绍两个人介绍，当B设备对应路由器添加了A设备对应的公网IP后，A设备就可以与B设备建立连接了，这个时候就可以顺畅的通信了！

                        Server S
                    10.47.58.139:9527
                           |
                           |
    +----------------------|----------------------+
    |                                             |
  NAT A                                         NAT B
122.27.219.161:10001                            123.29.210.131:10002
    |                                             |
    |                                             |
 Client A                                      Client B
 192.168.1.126:9901                           192.168.1.102:9902

如上图所示，CLientA与ClientB想要通信，因为两个客户端都在各自的局域网内，都是通过NAT技术生成公网映射IP的，想要彼此访问必须通过一个中间服务器进行中介介绍，这样两个客户端才能彼此认识并建立连接，否则双方直接通信都会被路由器丢弃。那么为什么非要用NAT呢？直接为每个Client分配一个公网IP不可以吗？这是由于IPv4的限制，公网IP数量是有限的，我们国家拿到的公网IP段更是有限，甚至不及美国一所大学的IP段数量多。这样也就不可能为每个机器都分配一个公网IP，正因为此NAT技术才非常重要，它可以很好的帮我们解决公网IP不足的问题。

接下来我们还是介绍一下NAT的原理和类型：

NAT主要可以分为两类：

+ 基本NAT，这种要求NAT有多个公网IP，这样可以将公网IP和内网设备静态绑定
+ NAPT（Network Address Port Translation），更为常见的NAT，内网设备的网络请求通过不同端口加以映射

针对NAPT端口的映射方式，又可以分为四种形式：

+ 完全圆锥型NAT( Full Cone NAT )，将从一个内部IP地址和端口来的所有请求，都映射到相同的外部IP地址和端口。并且，任何外部主机通过向映射的外部地址发送报文，都可以实现和内部主机进行通信。
+ 地址限制圆锥型NAT( Address Restricted Cone NAT )，将从相同的内部IP地址和端口来的所有请求映射到相同的公网IP地址和端口。但是与完全圆锥型NAT不同，当且仅当内部主机之前已经向公网主机发送过报文，此时公网主机才能向内网主机发送报文。
+ 端口限制圆锥型NAT( Port Restricted Cone NAT )，端口受限圆锥型NAT增加了端口号的限制，当前仅当内网主机之前已经向公网主机发送了报文，公网主机才能和此内网主机通信。
+ 对称型NAT( Symmetric NAT)，把从同一内网地址和端口到相同目的地址和端口的所有请求，都映射到同一个公网地址和端口。如果同一个内网主机，用相同的内网地址和端口向另外一个目的地址发送报文，则会用不同的映射。

本人经过检测发现，本机的NAT类型为上述第四种：Symmetric NAT

知识点普及后，我们继续来实践我们之前所说的p2p技术，也就是两个设备之间的通信问题，由于两个设备分别在各自的网络内部，我们也称这种行为为打洞！

接下来我们用go语言来实现这个打洞技术，主要使用UDP来实现，具体流程如下：

建立UDP服务器 S
1. 建立A、B客户端，分别与S建立会话，SA与SB
2. S当好中介人，将A的ip+端口通过SB告诉B，将B的ip+端口通过SA告诉A
3. A向B公网地址发送一个UDP包，代表握手，打通A-B的路径
4. B向A公网地址发送一个UDP包，A-B的会话建立成功
